<!doctype html>
<meta charset="utf-8">
<title>LC Zentrale</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0f1115;color:#e6eefc;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #222}
  .pill{font:12px;background:#233656;border-radius:999px;padding:3px 8px}
  .wrap{display:flex;gap:10px;height:calc(100vh - 50px);padding:12px}
  .inbox{width:300px;border-right:1px solid #222;padding-right:10px;overflow:auto}
  .item{background:#1b2135;border:1px solid #2a3451;border-radius:10px;padding:8px;cursor:pointer;margin-bottom:8px;text-align:left}
  .small{opacity:.8;font-size:12px}
  .view{flex:1;border:1px solid #222;border-radius:12px;background:#141824;padding:12px;display:flex;flex-direction:column;min-width:0}
  .msgs{flex:1;overflow:auto}
  .row{display:flex;gap:6px;margin-top:8px}
  input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #222;background:#0f1320;color:#fff;outline:none}
  button{background:#3a7afe;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.ghost{background:#1f2430;color:#ddd}
</style>

<header>
  <strong>LC Zentrale</strong>
  <span id="status" class="small">warte auf Tabs…</span>
  <span id="clients" class="pill">clients 0</span>
</header>

<div class="wrap">
  <div class="inbox">
    <div style="font-weight:600;margin-bottom:6px">Eingang</div>
    <div id="list"></div>
  </div>

  <div class="view">
    <div id="head" class="small">Nichts ausgewählt</div>
    <div id="msgs" class="msgs"><div class="small" style="opacity:.7">Noch keine Nachricht.</div></div>
    <div class="row">
      <input id="inp" placeholder="Antwort… (Enter)">
      <button id="send">Senden</button>
      <button id="clear" class="ghost">Leeren</button>
    </div>
    <div id="info" class="small" style="margin-top:6px"></div>
  </div>
</div>

<script>
(() => {
  try{ if(window.name!=='LC_HUB') window.name='LC_HUB'; }catch{}
  const list = document.getElementById('list');
  const msgs = document.getElementById('msgs');
  const head = document.getElementById('head');
  const status = document.getElementById('status');
  const info = document.getElementById('info');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('send');
  const clearBtn = document.getElementById('clear');
  const clientsBadge = document.getElementById('clients');
  const esc = s => (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  const clients = new Map(); // clientId -> {win, last, profile}
  const queue = [];
  let current = null;
  function updClients(){ clientsBadge.textContent = 'clients ' + clients.size; }

  function renderList(){
    list.innerHTML='';
    queue.forEach((m,i)=>{
      const el=document.createElement('button');
      el.className='item';
      el.innerHTML=`<div style="font-weight:600">${esc(m.profile||'Profil')}</div>
                    <div class="small">${new Date(m.ts).toLocaleTimeString()}</div>
                    <div class="small" style="opacity:.85">${esc(m.text.slice(0,90))}</div>`;
      el.onclick=()=>pick(i);
      list.appendChild(el);
    });
    status.textContent = `offen: ${queue.length}`;
  }
  function pick(i){
    const m=queue.splice(i,1)[0]; if(!m) return;
    current=m; renderList();
    head.textContent = `${m.profile} – ${new Date(m.ts).toLocaleString()}`;
    msgs.innerHTML = `<div><span class="small" style="opacity:.7">Kunde:</span> ${esc(m.text)}</div>`;
    inp.focus();
  }
  function addLine(who, text){
    const d=document.createElement('div');
    d.innerHTML=`<span class="small" style="opacity:.7">${esc(who)}:</span> ${esc(text)}`;
    msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
  }
  function sendNow(){
    const v=(inp.value||'').trim(); if(!v||!current) return;
    const c=clients.get(current.clientId); if(!c){ info.textContent='Client getrennt.'; return; }
    const reqId=Math.random().toString(36).slice(2);
    try{ c.win.postMessage({__LCX__:1,type:'REPLY',clientId:current.clientId,text:v,reqId},'*'); addLine('Du', v); inp.value=''; info.textContent='gesendet…'; }catch{}
  }
  sendBtn.onclick=sendNow;
  inp.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendNow(); }});
  clearBtn.onclick=()=>{ msgs.innerHTML=''; head.textContent='Nichts ausgewählt'; current=null; };

  window.addEventListener('message',(ev)=>{
    const d=ev.data||{}; if(!d.__LCX__) return;
    if(d.type==='HELLO'){
      clients.set(d.clientId,{win:ev.source,last:Date.now(),profile:d.profile||'Profil'});
      updClients(); ev.source.postMessage({__LCX__:1,type:'HELLO_ACK'},'*'); return;
    }
    if(d.type==='NEW'){
      if(!clients.has(d.clientId)) clients.set(d.clientId,{win:ev.source,last:Date.now(),profile:d.profile});
      else { const c=clients.get(d.clientId); c.last=Date.now(); c.profile=d.profile; }
      updClients();
      queue.push(d); renderList(); if(!current) pick(0);
      return;
    }
    if(d.type==='DELIVERED' && current && d.clientId===current.clientId){
      info.textContent = 'zugestellt ' + new Date(d.ts||Date.now()).toLocaleTimeString();
      setTimeout(()=>info.textContent='',1500);
    }
  });
})();
</script>
