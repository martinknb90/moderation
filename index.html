// ==UserScript==
// @name         LC Hub Client (minimal)
// @namespace    lc/ext
// @version      1.1
// @description  Schickt eingehende Nachrichten an die externe Hub-Seite; Antworten kommen zurück in den Tab.
// @match        https://livecreator.com/*
// @match        https://www.livecreator.com/*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(() => {
  'use strict';
  const HUB_URL = 'https://martinknb90.github.io/moderation/'; // deine Hub-Seite

  const ID = sessionStorage.getItem('LCX_ID') || (sessionStorage.setItem('LCX_ID', Math.random().toString(36).slice(2)), sessionStorage.getItem('LCX_ID'));
  const txt = el => (el?.innerText || el?.textContent || '').trim();

  // kleines Badge
  const badge=document.createElement('div');
  Object.assign(badge.style,{position:'fixed',top:'8px',right:'8px',zIndex:999999,background:'#a60',color:'#fff',padding:'6px 8px',borderRadius:'8px',font:'12px system-ui',cursor:'pointer'});
  badge.textContent='Hub öffnen';
  badge.onclick=()=>{ try{ window.open(HUB_URL,'LC_HUB'); }catch{} };
  document.body.appendChild(badge);

  let helloAck=false;
  function getHub(){ try{ const w=window.open('','LC_HUB'); return (w && !w.closed) ? w : null; }catch{ return null; } }
  function helloLoop(){
    const send=()=>{ const hub=getHub(); if(hub) hub.postMessage({__LCX__:1,type:'HELLO',clientId:ID,profile:getProfile()},'*'); };
    const t=setInterval(send,1500); send();
    const onMsg=(ev)=>{ const d=ev.data||{}; if(d.__LCX__ && d.type==='HELLO_ACK'){ helloAck=true; badge.style.background='#0a0'; badge.textContent='Hub verbunden'; badge.style.cursor='default'; badge.onclick=null; clearInterval(t); window.removeEventListener('message',onMsg); } };
    window.addEventListener('message',onMsg);
  }
  // wenn Hub bereits offen → verbinden, sonst Button lassen
  if (getHub()) helloLoop();

  function getProfile(doc=document){
    const c = doc.querySelector('.user-name, .dialog-head .user-name, .dialog-head .name, [class*="user-name"], .userbox-inner .user-name');
    const t = txt(c); if (t) return t;
    const title=(doc.title||'').replace(/\s+[-–|].*$/,'').trim();
    return title||'Profil';
  }

  const SEEN = new Set();
  const MSG = [
    '.chat-message.type-sender .msg > span.message.special > span',
    '.chat-message.type-sender .msg .message > span',
    '.chat-message.type-sender .msg',
    '.message.incoming .message-text',
    '.message:not(.outgoing) .message-text',
    '.msg.in .text',
    '[class*="incoming"] .text',
    '.chat_message','.message-text','.text'
  ];
  const LIST = ['.ons-scroll-content','.messages-list','.chat-content','.chatbox','[class*="scroll"]'];

  function startIn(doc){
    let target=doc.body;
    for(const s of LIST){ try{ const t=doc.querySelector(s); if(t){ target=t; break; } }catch{} }
    const push=(node)=>{
      const content=txt(node); if(!content) return;
      const key=(node.getAttribute?.('data-id')||'')+'::'+content.slice(0,160);
      if(SEEN.has(key)) return;
      const box=node.closest?.('.chat-message');
      const c=(box?.className||'')+' '+(node.className||'');
      if(/type-user|outgoing|own|self|right/i.test(c)) return; // nur eingehend
      SEEN.add(key);
      try{ const hub=getHub(); hub && hub.postMessage({__LCX__:1,type:'NEW',clientId:ID,profile:getProfile(doc),text:content,ts:Date.now()},'*'); }catch{}
    };
    const mo=new MutationObserver(muts=>{
      muts.forEach(m=>m.addedNodes.forEach(n=>{
        if(n.nodeType!==1) return;
        for(const s of MSG){
          try{
            if(n.matches?.(s)){ push(n); break; }
            const hit=n.querySelector?.(s); if(hit){ push(hit); break; }
          }catch{}
        }
      }));
    });
    try{ mo.observe(target,{childList:true,subtree:true}); }catch{}
    setInterval(()=>{ for(const s of MSG){ try{ doc.querySelectorAll(s).slice(-2).forEach(push); }catch{} } },2000);
  }

  startIn(document);
  document.querySelectorAll('iframe').forEach(f=>{ try{ f.contentDocument && startIn(f.contentDocument); }catch{} });

  function findInput(doc){ return doc.querySelector('textarea, input[placeholder*="Nachricht"], input[type="text"]'); }
  function findSend(doc){
    const byText=[...doc.querySelectorAll('button')].find(b=>(b.textContent||'').trim().toLowerCase().includes('senden'));
    return byText || doc.querySelector('button.send, button[type="submit"], button[aria-label="Send"]');
  }

  window.addEventListener('message',(ev)=>{
    const d=ev.data||{}; if(!d.__LCX__) return;
    if(d.type==='REPLY' && d.clientId===ID){
      let ok=false;
      const docs=[document]; document.querySelectorAll('iframe').forEach(f=>{ try{ if(f.contentDocument) docs.push(f.contentDocument); }catch{} });
      for(const doc of docs){
        try{
          const inp=findInput(doc); if(!inp) continue;
          inp.focus(); inp.value=d.text;
          inp.dispatchEvent(new Event('input',{bubbles:true}));
          inp.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,key:'Enter'}));
          const btn=findSend(doc); if(btn) setTimeout(()=>btn.click(),50);
          ok=true; break;
        }catch{}
      }
      try{ const hub=getHub(); hub && hub.postMessage({__LCX__:1,type:'DELIVERED',clientId:ID,reqId:d.reqId,ok,ts:Date.now()},'*'); }catch{}
    }
  });
})();
